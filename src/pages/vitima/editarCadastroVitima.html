<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
        integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <title>Editar Cadastro de Vítima</title>
</head>

<body>
    <div class="container-fluid col-md-8 mt-5 pt-5">
        <h1>Editar Cadastro de Vítima</h1>
        <p>Preencha os campos obrigatórios (*) antes de salvar.</p>
        <form id="editarCadastroVitimaForm">
            <div class="form-group">
                <label for="nomeCompleto">Nome Completo*:</label>
                <input type="text" id="nomeCompleto" name="nomeCompleto" class="form-control" </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="id_paisDeOrigem">Pais de origem:</label>
                        <select id="id_paisDeOrigem" class="form-control"></select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="id_autorDoCrime">Autor do Crime:*</label>

                        <select id="id_autorDoCrime" class="form-control"> </select>

                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="nacionalidade">Nacionalidade:*</label>
                            <select id="nacionalidade" class="form-control"> </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="altura">Altura*:</label>
                        <input type="text" id="altura" name="altura" class="form-control"
                            placeholder="Informe a altura">
                    </div>
                    <div class="form-group">
                        <label for="genero">Gênero*:</label>
                        <select id="genero" name="genero" class="form-control">
                            <option value="masculino">Masculino</option>
                            <option value="feminino">Feminino</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="idade">Idade*:</label>
                        <input type="text" id="idade" name="idade" class="form-control" placeholder="Informe a idade">
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="id_paisVistoPorUltimo">País Visto por Último:*</label>
                            <select id="id_paisVistoPorUltimo" class=form-control"></select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="status">Status*:</label>
                        <select id="status" name="status" class="form-control">
                            <option selected>Selecionar</option>
                            <option>Sequestrado(a)</option>
                            <option>Desaparecido(a)</option>
                            <option>Repatriado(a)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="foto">Foto*:</label>
                        <input type="text" id="foto" name="foto" class="form-control"
                            placeholder="Informe a URL da foto">
                    </div>
                    <button type="submit" class="btn  btn-secondary">Salvar Alterações</button>
                    <a href="detalhesVitima.html">
                        <button type="button" class="btn btn-secondary">Cancelar</button>
                    </a>
        </form>
    </div>

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"
        integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"
        crossorigin="anonymous"></script>


    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script>

        function getIdURL() {
            const url = window.location.href;
            const urlObj = new URL(url);
            return urlObj.searchParams.get("id");
        }

        async function buscarDetalhesVitima() {
            const id = getIdURL();
            try {
                const response = await axios.get(`http://localhost:3337/api/vitima/${id}`);
                const vitima = response.data;
                document.getElementById("nomeCompleto").value = vitima.nomeCompleto;
                document.getElementById("id_paisDeOrigem").value = vitima.id_paisDeOrigem;
                document.getElementById("id_autorDoCrime").value = vitima.id_autorDoCrime;
                document.getElementById("nacionalidade").value = vitima.nacionalidade;
                document.getElementById("altura").value = vitima.altura;
                document.getElementById("genero").value = vitima.genero;
                document.getElementById("idade").value = vitima.idade;
                document.getElementById("id_paisVistoPorUltimo").value = vitima.id_paisVistoPorUltimo;
                document.getElementById("status").value = vitima.statusDaVitima;
                document.getElementById("foto").value = vitima.foto;
            } catch (error) {
                console.error("Erro ao buscar detalhes da vítima:", error);
            }
        }
        buscarDetalhesVitima();

        document.getElementById("editarCadastroVitimaForm").addEventListener("submit", function (event) {
            event.preventDefault();
            const id = getIdURL();
            if (!id) {
                console.error("ID da vítima ausente na URL.");
                return;
            }
            console.log("ID da vítima:", id);
            const nomeCompleto = document.getElementById("nomeCompleto").value;
            const id_paisDeOrigem = document.getElementById("id_paisDeOrigem").value;
            const id_autorDoCrime = document.getElementById("id_autorDoCrime").value;
            const nacionalidade = document.getElementById("nacionalidade").value;
            const altura = document.getElementById("altura").value;
            const genero = document.getElementById("genero").value;
            const idade = parseInt(document.getElementById("idade").value);
            const paisVistoPorUltimo = document.getElementById("id_paisVistoPorUltimo").value;
            const statusDaVitima = document.getElementById("status").value;
            const foto = document.getElementById("foto").value;

            const data = {
                id_paisDeOrigem: id_paisDeOrigem,
                id_autorDoCrime: id_autorDoCrime,
                nomeCompleto: nomeCompleto,
                nacionalidade: nacionalidade,
                altura: altura,
                genero: genero,
                idade: idade,
                id_paisVistoPorUltimo: paisVistoPorUltimo,
                statusDaVitima: statusDaVitima,
                foto: foto
            };
            console.log("Dados a serem enviados:", data);
          
            axios.put(`http://localhost:3337/api/vitima/`, { id, ...data })
                .then(function (response) {
                    console.log("Atualização de vítima bem-sucedida!", response.data);
                    window.location.href = `detalhesVitima.html?id=${id}`;
                })
                .catch(function (error) {
                    console.error("Erro ao atualizar vítima:", error);
                });
        });

        // Função para preencher dinamicamente os campos de Pais de origem e nacionalidade.
        function buscarDadosDoServidor(endpoint, campoDeSelecao, colunaDaTabela, valorOpcaoDoSelect) {
            axios.get(endpoint)
                .then(function (response) {
                    const select = document.getElementById(campoDeSelecao);
                    for (let i in response.data) {
                        let option = document.createElement('option');
                        option.text = response.data[i][colunaDaTabela];
                        option.value = response.data[i][valorOpcaoDoSelect];
                        select.add(option);
                    }
                    function alterarValor() {
                        var valor = select.options[select.selectedIndex];
                        $('#' + campoDeSelecao).val(valor.value).trigger('change');
                    }
                    select.addEventListener('change', alterarValor);
                })
                .catch(function (error) {
                    console.error(error);
                });
        }
        buscarDadosDoServidor("http://localhost:3340/api/pais/", "id_paisDeOrigem", "nome", "id");
        buscarDadosDoServidor("http://localhost:3340/api/pais/", "nacionalidade", "gentilico", "id");
        buscarDadosDoServidor("http://localhost:3340/api/pais/", "id_paisVistoPorUltimo", "nome", "id");
        buscarDadosDoServidor("http://localhost:3338/api/criminoso/", "id_autorDoCrime", "nomeCompleto", "id");
    </script>
</body>
</html>